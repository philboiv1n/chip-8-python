<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="data:,">
  <title>CHIP-8 Python Emulator | Phil Boivin</title>
  <style>
    html, body {font-family: Arial, Helvetica, sans-serif; height: 100%; margin: 0;}
    body {display: flex; justify-content: center; align-items: center; background-color: #eeeeee;}
    h1 {font-family: 'Courier New', Courier, monospace;}
    .content {text-align: center;}
    canvas {image-rendering: pixelated; border: 2px solid #ccc; margin: 32px 0}
  </style>
</head>
<body>


<!-- HTML -->
  <div class="content">
    <h1>CHIP-8 Emulator</h1>
    <div>
      1 - <input type="file" id="romInput" accept=".ch8" />
      2 - <button id="loadBtn">Load ROM</button>
      <span id="status"></span>
    </div>
    <canvas id="screen" width="64" height="32"></canvas>
  </div>



<!-- Javascript -->
  <script>
    const canvas = document.getElementById("screen");
    const ctx = canvas.getContext("2d");
    const imageData = ctx.createImageData(64, 32);

    // Upscale for visibility
    const SCALE = 10;
    canvas.style.width  = 64 * SCALE + "px";
    canvas.style.height = 32 * SCALE + "px";

    // Map PC keys to CHIP-8 keypad
    const keymap = {
      Digit1: 0x1, Digit2: 0x2, Digit3: 0x3, Digit4: 0xC,
      KeyQ:    0x4, KeyW:    0x5, KeyE:    0x6, KeyR:    0xD,
      KeyA:    0x7, KeyS:    0x8, KeyD:    0x9, KeyF:    0xE,
      KeyZ:    0xA, KeyX:    0x0, KeyC:    0xB, KeyV:    0xF
    };

    let emulatorStarted = false;

    function startEmulator() {
      if (emulatorStarted) return;
      emulatorStarted = true;
      const ws = new WebSocket(`ws://${location.host}/ws`);
      ws.binaryType = "arraybuffer";

      // Binary key event encoding: 0 = key up, 1 = key down
      const KEY_UP = 0;
      const KEY_DOWN = 1;
      const downKeys = new Set();

      function sendKey(k, isDown) {
        const buf = new Uint8Array(2);
        buf[0] = isDown ? KEY_DOWN : KEY_UP;
        buf[1] = k;
        ws.send(buf.buffer);
      }

      ws.onopen = () => console.log("WebSocket connected");
      ws.onclose = () => {
        console.log("WebSocket closed");
        downKeys.clear();
        emulatorStarted = false;
      };
      ws.onerror = e => console.error("WebSocket error", e);

      ws.onmessage = event => {
        const buf = new Uint8Array(event.data);
        // buf.length should be 2048 (64Ã—32)
        for (let i = 0; i < buf.length; i++) {
          const v = buf[i] ? 255 : 0;
          const off = i * 4;
          imageData.data[off + 0] = v;
          imageData.data[off + 1] = v;
          imageData.data[off + 2] = v;
          imageData.data[off + 3] = 255;
        }
        ctx.putImageData(imageData, 0, 0);
      };

      window.addEventListener("keydown", e => {
        const k = keymap[e.code];
        if (k !== undefined && !e.repeat && !downKeys.has(e.code)) {
          downKeys.add(e.code);
          sendKey(k, true);
        }

      });
      window.addEventListener("keyup", e => {
        const k = keymap[e.code];
        if (k !== undefined && downKeys.has(e.code)) {
          downKeys.delete(e.code);
          sendKey(k, false);
        }
      });
    }

    document.getElementById("loadBtn").onclick = async () => {
      const input = document.getElementById("romInput");
      if (!input.files.length) {
        alert("Please select a .ch8 file");
        return;
      }
      const file = input.files[0];
      document.getElementById("status").textContent = "Uploading...";
      const form = new FormData();
      form.append("file", file);
      const res = await fetch("/load", { method: "POST", body: form });
      if (res.ok) {
        document.getElementById("status").textContent = "Loaded!";
        startEmulator();
      } else {
        const err = await res.json();
        document.getElementById("status").textContent = "Error: " + err.detail;
      }
    };
  </script>

</body>
</html>